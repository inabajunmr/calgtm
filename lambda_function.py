import requests
from PIL import Image, ImageFont, ImageDraw
import urllib.request
import io
import base64

def lambda_handler(event, context):
    img_url = event['img']
    # TODO handling exception
    img_binary = get_img(img_url)
    lgtm_img_binary = lgtm(img_binary)
    
    response = {
        "statusCode": 200,
        "headers":{
            "Content-Type": "image/jpeg",
        },
        "isBase64Encoded": True,
        "body" : str(base64.b64encode(lgtm_img_binary).decode("utf-8"))
        }
    return response

def lgtm(img_binary, fillcolor="white", shadowcolor="black"):
    img = Image.open(img_binary)

    # convert to jpg
    img.convert("RGB")
    # compress for too big image
    img.thumbnail((1024, 1024), Image.ANTIALIAS)
    width, height = img.size

    # adjust font size
    font_size = width / 2 if width <= height else height / 2

    draw = ImageDraw.Draw(img)

    # calculate text size
    font_name = "LiberationSans-Bold.ttf"
    font = ImageFont.truetype(font_name, int(font_size))
    text = "LGTM!"
    text_w, text_h = draw.textsize(text, font)

    # resize font size until text does not run off image.
    while text_w > width or text_h > height:
        font_size = font_size - 1
        font = ImageFont.truetype(font_name, int(font_size))
        text_w, text_h = draw.textsize(text, font)

    # adjust place of text
    x, y = (width - text_w)/2, (height - text_h)/2

    # draw border
    draw.text((x, y-1), text, font=font, fill=shadowcolor)
    draw.text((x, y+1), text, font=font, fill=shadowcolor)
    draw.text((x+1, y-1), text, font=font, fill=shadowcolor)
    draw.text((x+1, y), text, font=font, fill=shadowcolor)
    draw.text((x+1, y+1), text, font=font, fill=shadowcolor)
    draw.text((x-1, y+1), text, font=font, fill=shadowcolor)
    draw.text((x-1, y), text, font=font, fill=shadowcolor)
    draw.text((x-1, y-1), text, font=font, fill=shadowcolor)

    # draw main text
    draw.text((x, y), text, font=font, fill=fillcolor)

    output = io.BytesIO()
    img.save(output, format='JPEG')
    return output.getvalue()

def get_img(url):
    req = urllib.request.Request(url)
    image_read = urllib.request.urlopen(req).read()
    img_binary = io.BytesIO(image_read)
    return img_binary

event = {
    "params" : {
        "querystrings" : {
            "img" : "data:image/jpeg;base64,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"
        }
    }
}